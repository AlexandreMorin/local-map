import json # jsonfy search result
import sys 	# sys.exit()
import ldap # ldap connection request
ldap.set_option(ldap.OPT_REFERRALS, 0)
ldap.set_option(ldap.OPT_TIMEOUT, 10)

######################################################
with open('../package.json') as data_file:
  settings = json.load(data_file)

Server = settings['localmap']['url']
BaseDN = settings['localmap']['baseDN']
User = settings['localmap']['username']
Password = settings['localmap']['password']

Filter = 'cn=*'
Attrs = ('cn', 'physicalDeliveryOfficeName','mail')
#######################################################

# con = ldap.initialize('ldap://klee.lan.net')
# ldap_user = "Reader-LocalMap@KLEE.LAN.NET"
# passwd = "Dd2*[r{WPtSc0CZ-?cYL"
# base_dn = "ou=Utilisateurs,dc=klee,dc=lan,dc=net"

# con.simple_bind_s(ldap_user, passwd)
# filter_str = "cn=*Zekun*"
# attrs = ('cn', 'physicalDeliveryOfficeName', 'mail')

con = ldap.initialize(Server)
ldap_user = User
passwd = Password
base_dn = BaseDN

con.simple_bind_s(ldap_user, passwd)
print "sucess connection !"

filter_str = Filter
attrs = Attrs 

result = con.search_s(base_dn, ldap.SCOPE_SUBTREE, filterstr=filter_str, attrlist=attrs)
print result
with open('../api/data/KleeGroup.json', 'w') as json_file:
	json.dump(result, json_file, ensure_ascii=False)

con.unbind_s()
sys.exit()